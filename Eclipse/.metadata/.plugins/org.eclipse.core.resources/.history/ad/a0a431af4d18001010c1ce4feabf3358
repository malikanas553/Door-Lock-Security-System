/*
 * main_MC1.c
 *
 *  Created on: Apr 8, 2025
 *      Author: LightStore
 */

#include "lcd.h"
#include "keypad.h"
#include "interrupt.h"
#include "std_types.h"
#include <util/delay.h>
#include "uart.h"
#include "timer.h"


#define PASSWORD_DIGITS 	5
#define MC2_READY      		0xE0
#define GET_STATUS     		0xE1
#define SET_NEW_PASS   		0xE2
#define NEXT_DIGIT     		0xE3
#define CONFIRM_PASS   		0xE4
#define PASS_MATCH     		0xE5
#define PASS_NO_MATCH  		0xE6
#define DOOR_CHECK_PASS     0xE7
#define CHANGE_CHECK_PASS   0xE8
#define RECIEVED            0xE9
#define ATTEMPTS_ENDED      0xF0
#define UNLOCK_DOOR         0xF1
#define LOCK_DOOR           0xF2

#define BUTTON_DEBOUNCE 150

#define MILLISECONDS_TO_TICKS(ms)  (((F_CPU / 1024) * (ms)) / 1000)

UART_ConfigType UART_CONFIG = {EIGHT_BITS,NO_PARITY,ONE_STOP_BIT,4800};
Timer_ConfigType TIMER1_CONFIG = {0,(uint16)(MILLISECONDS_TO_TICKS(1000)),TIMER_1,F_CPU_1024,CTC_MODE_OC_DISABLED};

volatile uint8 received_key;
static volatile uint8 time = 0;
void HMI_countSeconds(void)
{
	time++;
}
void HMI_sendPassword(uint8 * password,uint8 command)
{
	//LCD_moveCursor(1,10);
	UART_sendByte(command);
	uint8 digits = 0;
	while(digits < 5){
		UART_sendByte(password[digits]);
		while(UART_recieveByte() != NEXT_DIGIT);
		digits++;
	}
	UART_sendByte('#');


}
int main(void)
{
	uint8 key;
	uint8 system_status;
	volatile uint8 pass_status = 0;
	uint8 password[PASSWORD_DIGITS+1];
	uint8 attempts;
	Enable_Global_Interrupt();
	UART_init(&UART_CONFIG);
	LCD_init();
	Timer_setCallBack(HMI_countSeconds,TIMER_1);
	while(received_key != MC2_READY)
	{
		received_key = UART_recieveByte();
	}
	UART_sendByte(GET_STATUS);
	system_status = UART_recieveByte();
	while(1)
	{

		int digits = 0;
		attempts = 0;
		LCD_clearScreen();
		if(system_status != '#')
		{
			LCD_displayString("ENTER PASS: ");
			LCD_moveCursor(1,0);
			while(digits < PASSWORD_DIGITS)
			{
				key = KEYPAD_getPressedKey();
				if((key <= 9) && (key >= 0))
				{
					password[digits] = key;
					LCD_intgerToString(password[digits]);
					digits++;

				}
				_delay_ms(BUTTON_DEBOUNCE);
			}
			while(key != ENTER)
			{
				key = KEYPAD_getPressedKey();
			}
			LCD_clearScreen();

			HMI_sendPassword(password,SET_NEW_PASS);

			digits = 0;

			LCD_displayString("RE-ENTER PASS: ");
			LCD_moveCursor(1,0);
			while(digits < PASSWORD_DIGITS){
				key = KEYPAD_getPressedKey();
				if((key <= 9) && (key >= 0))
				{
					password[digits] = key;
					LCD_intgerToString(password[digits]);
					digits++;
				}
				_delay_ms(BUTTON_DEBOUNCE);
			}
			digits = 0;
			while(key != 13)
			{
				key = KEYPAD_getPressedKey();

			}
			HMI_sendPassword(password,CONFIRM_PASS);
			pass_status = UART_recieveByte();
			if(pass_status == PASS_MATCH){
				_delay_ms(500);
				LCD_clearScreen();
				system_status = '#';
			}else
			{
				LCD_clearScreen();
				LCD_displayString("PASS DONT MATCH");
				_delay_ms(1000);
				LCD_clearScreen();
			}

		}else
		{

			LCD_displayString("+ : Open Door");
			LCD_moveCursor(1,0);
			LCD_displayString("- : Change Pass");

			while((key != '+') && (key != '-'))
			{
				key = KEYPAD_getPressedKey();
			}
			if(key == '+')
			{
				pass_status = 0;
				LCD_clearScreen();
				while(pass_status != PASS_MATCH){
					if(attempts == 3)
					{
						UART_sendByte(ATTEMPTS_ENDED);
						LCD_displayString("SYSTEM LOCKED");
						time = 0;
						Timer_init(&TIMER1_CONFIG);
						while(time < 60);
						time = 0;
						Timer_deInit(TIMER_1);
						break;
					}
					LCD_displayString("ENTER PASS: ");
					LCD_moveCursor(1,0);
					while(digits < PASSWORD_DIGITS)
					{
						key = KEYPAD_getPressedKey();
						if((key <= 9) && (key >= 0))
						{
							password[digits] = key;
							LCD_intgerToString(password[digits]);
							digits++;

						}
						_delay_ms(BUTTON_DEBOUNCE);
					}

					while(key != ENTER)
					{
						key = KEYPAD_getPressedKey();
					}
					LCD_clearScreen();

					HMI_sendPassword(password,DOOR_CHECK_PASS);

					pass_status = UART_recieveByte();
					if(pass_status == PASS_MATCH){
						attempts = 0;
						LCD_displayString("PASS MATCH");
						_delay_ms(500);
						UART_sendByte(UNLOCK_DOOR);
						LCD_clearScreen();
						LCD_displayString("DOOR IS UNLOCKING");
						time = 0;
						Timer_init(&TIMER1_CONFIG);
						while(time < 15);
						time = 0;
						Timer_deInit(TIMER_1);
						LCD_clearScreen();
						LCD_displayString("WAIT FOR PEOPLE");
						LCD_moveCursor(1,4);
						LCD_displayString("TO ENTER");
						while(UART_recieveByte() != LOCK_DOOR);
						LCD_clearScreen();
						LCD_displayString("DOOR IS LOCKING");
						Timer_init(&TIMER1_CONFIG);
						while(time < 15);
						time = 0;
						Timer_deInit(TIMER_1);
						LCD_clearScreen();

					}else
					{
						attempts++;
						LCD_displayString("PASS DONT MATCH");
						_delay_ms(500);
						LCD_clearScreen();
					}

					digits = 0;

				}
			}else
			{
				pass_status = 0;
				LCD_clearScreen();
				while(pass_status != PASS_MATCH){
					if(attempts == 3)
					{
						UART_sendByte(ATTEMPTS_ENDED);
						LCD_displayString("SYSTEM LOCKED");
						time = 0;
						Timer_init(&TIMER1_CONFIG);
						while(time < 60);
						time = 0;
						Timer_deInit(TIMER_1);
						break;
					}
					LCD_displayString("ENTER PASS: ");
					LCD_moveCursor(1,0);
					while(digits < PASSWORD_DIGITS)
					{
						key = KEYPAD_getPressedKey();
						if((key <= 9) && (key >= 0))
						{
							password[digits] = key;
							LCD_intgerToString(password[digits]);
							digits++;

						}
						_delay_ms(BUTTON_DEBOUNCE);
					}

					while(key != ENTER)
					{
						key = KEYPAD_getPressedKey();
					}
					LCD_clearScreen();

					HMI_sendPassword(password,DOOR_CHECK_PASS);

					pass_status = UART_recieveByte();
					if(pass_status == PASS_MATCH){
						LCD_displayString("PASS MATCH");
						_delay_ms(500);
						LCD_clearScreen();
						system_status = 0;
					}else
					{
						attempts++;
						LCD_displayString("PASS DONT MATCH");
						_delay_ms(1000);
						LCD_clearScreen();
					}

					digits = 0;
				}
			}
		}
	}
	return 0;
}
